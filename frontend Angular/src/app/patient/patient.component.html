

     @if(showButtons){
      <div class="main-container">

      <div class="patient-buttons">
        @if (isLoggedIn()) {
        <button class="patient-btn" (click)="openPopup()" [hidden]="!(isAdmin || isSecretary)">
          Add Patient
        </button>
           
        <form [formGroup]="searchForm" (submit)="openSearchPopup()">
          <button type="submit" class="patient-btn"> Search</button>
        </form>
      }
      </div>
      </div>
      }   
      
      @if (showPopup) {
        <div class="popup-overlay">
          <div class="popup">
            <h2> Add a patient</h2>
            <form [formGroup]="addPatientForm" (submit)="addPatient()">
              <label for="patientIdentity"> ID number: </label>
              <input id="patientIdentity" type="text" formControlName="patientIdentity">
              @if (patientIdentity?.invalid && (patientIdentity?.dirty || patientIdentity?.touched)) {
                <div class="error-message">
                  @if (patientIdentity?.errors?.['required']) {
                    <span>ID number is required</span>
                  }
                  @if (patientIdentity?.errors?.['pattern']) {
                    <span>ID must be 9 digits</span>
                  }
                  @if (patientIdentity?.errors?.['invalidIsraeliId']) {
                    <span>Invalid Israeli ID</span>
                  }
                </div>
              }
      
              <label for="name"> Name:</label>
              <input id="name" type="text" formControlName="name">
              @if (name?.invalid && (name?.dirty || name?.touched)) {
                <div class="error-message">
                  @if (name?.errors?.['required']) {
                    <span>Name is required</span>
                  }
                  @if (name?.errors?.['minlength']) {
                    <span>Name must be at least 2 characters</span>
                  }
                  @if (name?.errors?.['maxlength']) {
                    <span>Name cannot exceed 50 characters</span>
                  }
                  @if (name?.errors?.['pattern']) {
                    <span>Name can only contain letters (English or Hebrew) and spaces</span>
                  }
                </div>
              }
              
              <label for="dateOfBirth"> Date Of Birth:</label>
              <input id="dateOfBirth" type="date" formControlName="dateOfBirth">
              @if (dateOfBirth?.invalid && (dateOfBirth?.dirty || dateOfBirth?.touched)) {
                <div class="error-message">
                  @if (dateOfBirth?.errors?.['required']) {
                    <span>Date of birth is required</span>
                  }
                  @if (dateOfBirth?.errors?.['futureDate']) {
                    <span>Date of birth cannot be in the future</span>
                  }
                  @if (dateOfBirth?.errors?.['tooOld']) {
                    <span>Patient age exceeds 120 years</span>
                  }
                </div>
              }
      
              <label for="gender"> Gender:</label>
              <select id="gender" formControlName="gender">
                <option value="◊ñ◊õ◊®">Male</option>
                <option value="◊†◊ß◊ë◊î">Female</option>
              </select>
              @if (gender?.invalid && (gender?.dirty || gender?.touched)) {
                <div class="error-message">
                  @if (gender?.errors?.['required']) {
                    <span>Gender is required</span>
                  }
                </div>
              }
      
              <label for="address"> Address:</label>
              <input id="address" type="text" formControlName="address">
              @if (address?.invalid && (address?.dirty || address?.touched)) {
                <div class="error-message">
                  @if (address?.errors?.['required']) {
                    <span>Address is required</span>
                  }
                  @if (address?.errors?.['minlength']) {
                    <span>Address must be at least 5 characters</span>
                  }
                  @if (address?.errors?.['maxlength']) {
                    <span>Address cannot exceed 100 characters</span>
                  }
                </div>
              }
      
              <label for="phone"> Phone:</label>
              <input id="phone" type="text" formControlName="phone">
              @if (phone?.invalid && (phone?.dirty || phone?.touched)) {
                <div class="error-message">
                  @if (phone?.errors?.['required']) {
                    <span>Phone number is required</span>
                  }
                  @if (phone?.errors?.['pattern']) {
                    <span>Phone must be 10 digits starting with 05</span>
                  }
                </div>
              }
      
              <label for="email"> Email:</label>
              <input id="email" type="email" formControlName="email">
              @if (email?.invalid && (email?.dirty || email?.touched)) {
                <div class="error-message">
                  @if (email?.errors?.['required']) {
                    <span>Email is required</span>
                  }
                  @if (email?.errors?.['email'] || email?.errors?.['pattern']) {
                    <span>Please enter a valid email address</span>
                  }
                </div>
              }
              
              <div class="button-group">
                <button type="submit" class="btn-primary"> Add Patient</button>
                <button type="button" class="btn-secondary" (click)="closePopup()">‚ùå Close</button>
              </div>
            </form>
          </div>
        </div>
      }
      
      
      @if (showSecondPopup) {
        <div class="popup-overlay">
          <div class="popup">
            
            <h2> Add a form</h2>   
            <form [formGroup]="patientForm" (submit)="addPatientFile()" >
              <label for="descreption"> Description:</label>
              <input id="descreption" type="text" formControlName="descreption">
              @if (patientForm.get('descreption')?.invalid && (patientForm.get('descreption')?.dirty || patientForm.get('descreption')?.touched)) {
                <div class="error-message">
                  @if (patientForm.get('descreption')?.errors?.['required']) {
                    <span>Description is required</span>
                  }
                  @if (patientForm.get('descreption')?.errors?.['minlength']) {
                    <span>Description must be at least 3 characters</span>
                  }
                  @if (patientForm.get('descreption')?.errors?.['maxlength']) {
                    <span>Description cannot exceed 200 characters</span>
                  }
                </div>
              }
      
              <label for="status"> Status:</label>
              <select id="status" formControlName="status">
                <option value="Waiting">Waiting</option>
                <option value="In Treatment">In Treatment</option>
                <option value="Treated">Treated</option>
              </select>
              @if (patientForm.get('status')?.invalid && (patientForm.get('status')?.dirty || patientForm.get('status')?.touched)) {
                <div class="error-message">
                  @if (patientForm.get('status')?.errors?.['required']) {
                    <span>Status is required</span>
                  }
                </div>
              }
      
              <h3> Attributes:</h3>
              <div class="attributes-table">
                @for (chunk of attributesChunks; track $index) {
                  <div class="attribute-column">
                    @for (attribute of chunk; track attribute.id) {
                      <label>
                        <input type="checkbox" [value]="attribute.id" (change)="toggleAttribute(attribute, $event)">
                        {{ attribute.attributeName }}
                      </label>
                    }
                  </div>
                }
              </div>
              
              <button type="button" (click)="calculateAndSaveScore()">üî¢ Calculate score
              </button>
              <p>Final Score {{ totalScore }}</p>
              
              <div class="button-group">
                <button type="submit" class="btn-primary">üìé Add a form</button>
                <button type="button" class="btn-secondary" (click)="closeSecondPopup()">‚ùå Close</button>
              </div>
            </form>
          </div>
        </div>
      }
      
      @if (lastFileId) {
        <button type="button" class="btn-update" (click)="updatePatientFile(lastFileId, totalScore)">üîÑ Update form</button>
      }
        
      
      @if (showSearchPopup) {
        <div class="popup-overlay-search">
          <div class="popup">
            <h2> Search patient </h2>
            <form [formGroup]="searchForm" (submit)="searchPatientById()">
              <label for="identity"> ID number:</label>
              <input id="identity" type="text" formControlName="identity">
              @if (searchForm.get('identity')?.invalid && (searchForm.get('identity')?.dirty || searchForm.get('identity')?.touched)) {
                <div class="error-message">
                  @if (searchForm.get('identity')?.errors?.['required']) {
                    <span>ID number is required</span>
                  }
                  @if (searchForm.get('identity')?.errors?.['pattern']) {
                    <span>ID must be 9 digits</span>
                  }
                  @if (searchForm.get('identity')?.errors?.['invalidIsraeliId']) {
                    <span>Invalid Israeli ID</span>
                  }
                </div>
              }
      
              <div class="button-group">
                <button type="submit" class="btn-primary"> Search</button>
                <button type="button" class="btn-secondary" (click)="closeSearchPopup()">‚ùå Close</button>
              </div>
            </form>
          </div>
        </div>
      }
      
      @if (selectedPatient) {
        <div class="popup-patient-details">
          <button type="button" class="delete-btn" (click)="confirmDeletePaient(selectedPatient?.patientIdentity)">delete patient üóëÔ∏è</button>
          <button type="button" class="update-btn" (click)="openUpdatePopup(selectedPatient)">◊¢◊ì◊õ◊ü ◊û◊ò◊ï◊§◊ú</button>
          <h2> Patient Details</h2>
          <div class="popup-patient-info">
            <p><strong> ID number:</strong> {{ selectedPatient?.patientIdentity }}</p>
            <p><strong> Name:</strong> {{ selectedPatient?.name }}</p>
            <p><strong> Date of birth:</strong> {{ selectedPatient?.dateOfBirth }}</p>
            <p><strong> Gender:</strong> {{ selectedPatient?.gender }}</p>
            <p><strong> Address:</strong> {{ selectedPatient?.address }}</p>
            <p><strong> Phone:</strong> {{ selectedPatient?.phone }}</p>
            <p><strong> Entry Time:</strong> {{ selectedPatient?.entryTime | date: 'dd/MM/yyyy HH:mm:ss' }}</p>
          </div>
      
          <div class="button-group">
            <button class="add-patient-btn" (click)="openSecondPopup()" [hidden]="!(isAdmin || isSecretary)">
               Add Form
            </button>
            
            @if (lastFileId) {
              <button type="button" class="btn-update" (click)="updatePatientFile(lastFileId, totalScore)">
                üîÑ Update Form
              </button>
            }
          </div>
          
          <h3> Existing Forms:</h3>
          <div class="forms-container">
            @for (file of patientFiles; track file.fileId) {
              <div class="form-card">
                <h4> Status: {{ file?.status }}</h4>
                <h4> Description:{{ file?.description }}</h4>
                <h4> Attribute Details:</h4>
                <ul>
                  @for (attr of file.attributes; track attr.attributeId) {
                    <li><strong>{{ attr?.attributeName }}</strong> - Score: {{ attr?.score }}</li>
                  }
                </ul>
              </div>
            }
          </div>
          <button type="button" class="btn-secondary" (click)="closeAddAnotherForm()">‚ùå Close</button>
        </div>
      }

      <!-- ◊î◊ï◊°◊£ ◊ê◊™ ◊î◊ß◊ï◊ì ◊î◊ë◊ê ◊ú◊™◊ë◊†◊ô◊™ HTML ◊©◊ú◊ö -->

@if (showUpdatePopup) {
  <div class="popup-overlay">
    <div class="popup">
      <h2>◊¢◊ì◊õ◊ï◊ü ◊§◊®◊ò◊ô ◊û◊ò◊ï◊§◊ú</h2>
      <form [formGroup]="updatePatientForm" (submit)="updatePatient()">
        <label for="updatePatientIdentity">◊û◊°◊§◊® ◊ñ◊î◊ï◊™:</label>
        <input id="updatePatientIdentity" type="text" formControlName="patientIdentity">
        @if (updatePatientForm.get('patientIdentity')?.invalid && (updatePatientForm.get('patientIdentity')?.dirty || updatePatientForm.get('patientIdentity')?.touched)) {
          <div class="error-message">
            @if (updatePatientForm.get('patientIdentity')?.errors?.['required']) {
              <span>◊û◊°◊§◊® ◊ñ◊î◊ï◊™ ◊î◊ï◊ê ◊©◊ì◊î ◊ó◊ï◊ë◊î</span>
            }
            @if (updatePatientForm.get('patientIdentity')?.errors?.['pattern']) {
              <span>◊û◊°◊§◊® ◊ñ◊î◊ï◊™ ◊ó◊ô◊ô◊ë ◊ú◊î◊ô◊ï◊™ 9 ◊°◊§◊®◊ï◊™</span>
            }
            @if (updatePatientForm.get('patientIdentity')?.errors?.['invalidIsraeliId']) {
              <span>◊û◊°◊§◊® ◊ñ◊î◊ï◊™ ◊ô◊©◊®◊ê◊ú◊ô ◊ú◊ê ◊™◊ß◊ô◊ü</span>
            }
          </div>
        }

        <label for="updateName">◊©◊ù:</label>
        <input id="updateName" type="text" formControlName="name">
        @if (updatePatientForm.get('name')?.invalid && (updatePatientForm.get('name')?.dirty || updatePatientForm.get('name')?.touched)) {
          <div class="error-message">
            @if (updatePatientForm.get('name')?.errors?.['required']) {
              <span>◊©◊ù ◊î◊ï◊ê ◊©◊ì◊î ◊ó◊ï◊ë◊î</span>
            }
            @if (updatePatientForm.get('name')?.errors?.['minlength']) {
              <span>◊©◊ù ◊ó◊ô◊ô◊ë ◊ú◊î◊ô◊ï◊™ ◊ú◊§◊ó◊ï◊™ 2 ◊™◊ï◊ï◊ô◊ù</span>
            }
            @if (updatePatientForm.get('name')?.errors?.['maxlength']) {
              <span>◊©◊ù ◊ú◊ê ◊ô◊õ◊ï◊ú ◊ú◊¢◊ë◊ï◊® 50 ◊™◊ï◊ï◊ô◊ù</span>
            }
            @if (updatePatientForm.get('name')?.errors?.['pattern']) {
              <span>◊©◊ù ◊ô◊õ◊ï◊ú ◊ú◊î◊õ◊ô◊ú ◊®◊ß ◊ê◊ï◊™◊ô◊ï◊™ (◊ê◊†◊í◊ú◊ô◊™ ◊ê◊ï ◊¢◊ë◊®◊ô◊™) ◊ï◊®◊ï◊ï◊ó◊ô◊ù</span>
            }
          </div>
        }
        
        <label for="updateDateOfBirth">◊™◊ê◊®◊ô◊ö ◊ú◊ô◊ì◊î:</label>
        <input id="updateDateOfBirth" type="date" formControlName="dateOfBirth">
        @if (updatePatientForm.get('dateOfBirth')?.invalid && (updatePatientForm.get('dateOfBirth')?.dirty || updatePatientForm.get('dateOfBirth')?.touched)) {
          <div class="error-message">
            @if (updatePatientForm.get('dateOfBirth')?.errors?.['required']) {
              <span>◊™◊ê◊®◊ô◊ö ◊ú◊ô◊ì◊î ◊î◊ï◊ê ◊©◊ì◊î ◊ó◊ï◊ë◊î</span>
            }
            @if (updatePatientForm.get('dateOfBirth')?.errors?.['futureDate']) {
              <span>◊™◊ê◊®◊ô◊ö ◊ú◊ô◊ì◊î ◊ú◊ê ◊ô◊õ◊ï◊ú ◊ú◊î◊ô◊ï◊™ ◊ë◊¢◊™◊ô◊ì</span>
            }
            @if (updatePatientForm.get('dateOfBirth')?.errors?.['tooOld']) {
              <span>◊í◊ô◊ú ◊î◊û◊ò◊ï◊§◊ú ◊¢◊ï◊ú◊î ◊¢◊ú 120 ◊©◊†◊ô◊ù</span>
            }
          </div>
        }

        <label for="updateGender">◊û◊í◊ì◊®:</label>
        <select id="updateGender" formControlName="gender">
          <option value="◊ñ◊õ◊®">◊ñ◊õ◊®</option>
          <option value="◊†◊ß◊ë◊î">◊†◊ß◊ë◊î</option>
        </select>
        @if (updatePatientForm.get('gender')?.invalid && (updatePatientForm.get('gender')?.dirty || updatePatientForm.get('gender')?.touched)) {
          <div class="error-message">
            @if (updatePatientForm.get('gender')?.errors?.['required']) {
              <span>◊û◊í◊ì◊® ◊î◊ï◊ê ◊©◊ì◊î ◊ó◊ï◊ë◊î</span>
            }
          </div>
        }

        <label for="updateAddress">◊õ◊™◊ï◊ë◊™:</label>
        <input id="updateAddress" type="text" formControlName="address">
        @if (updatePatientForm.get('address')?.invalid && (updatePatientForm.get('address')?.dirty || updatePatientForm.get('address')?.touched)) {
          <div class="error-message">
            @if (updatePatientForm.get('address')?.errors?.['required']) {
              <span>◊õ◊™◊ï◊ë◊™ ◊î◊ô◊ê ◊©◊ì◊î ◊ó◊ï◊ë◊î</span>
            }
            @if (updatePatientForm.get('address')?.errors?.['minlength']) {
              <span>◊õ◊™◊ï◊ë◊™ ◊ó◊ô◊ô◊ë◊™ ◊ú◊î◊ô◊ï◊™ ◊ú◊§◊ó◊ï◊™ 5 ◊™◊ï◊ï◊ô◊ù</span>
            }
            @if (updatePatientForm.get('address')?.errors?.['maxlength']) {
              <span>◊õ◊™◊ï◊ë◊™ ◊ú◊ê ◊ô◊õ◊ï◊ú◊î ◊ú◊¢◊ë◊ï◊® 100 ◊™◊ï◊ï◊ô◊ù</span>
            }
          </div>
        }

        <label for="updatePhone">◊ò◊ú◊§◊ï◊ü:</label>
        <input id="updatePhone" type="text" formControlName="phone">
        @if (updatePatientForm.get('phone')?.invalid && (updatePatientForm.get('phone')?.dirty || updatePatientForm.get('phone')?.touched)) {
          <div class="error-message">
            @if (updatePatientForm.get('phone')?.errors?.['required']) {
              <span>◊û◊°◊§◊® ◊ò◊ú◊§◊ï◊ü ◊î◊ï◊ê ◊©◊ì◊î ◊ó◊ï◊ë◊î</span>
            }
            @if (updatePatientForm.get('phone')?.errors?.['pattern']) {
              <span>◊û◊°◊§◊® ◊ò◊ú◊§◊ï◊ü ◊ó◊ô◊ô◊ë ◊ú◊î◊ô◊ï◊™ 10 ◊°◊§◊®◊ï◊™ ◊î◊û◊™◊ó◊ô◊ú◊ï◊™ ◊ë-05</span>
            }
          </div>
        }

        <label for="updateEmail">◊ê◊ô◊û◊ô◊ô◊ú:</label>
        <input id="updateEmail" type="email" formControlName="email">
        @if (updatePatientForm.get('email')?.invalid && (updatePatientForm.get('email')?.dirty || updatePatientForm.get('email')?.touched)) {
          <div class="error-message">
            @if (updatePatientForm.get('email')?.errors?.['required']) {
              <span>◊ê◊ô◊û◊ô◊ô◊ú ◊î◊ï◊ê ◊©◊ì◊î ◊ó◊ï◊ë◊î</span>
            }
            @if (updatePatientForm.get('email')?.errors?.['email'] || updatePatientForm.get('email')?.errors?.['pattern']) {
              <span>◊ê◊†◊ê ◊î◊ñ◊ü ◊õ◊™◊ï◊ë◊™ ◊ê◊ô◊û◊ô◊ô◊ú ◊™◊ß◊ô◊†◊î</span>
            }
          </div>
        }
        
        <div class="button-group">
          <button type="submit" class="btn-primary"> ◊¢◊ì◊õ◊ü ◊û◊ò◊ï◊§◊ú</button>
          <button type="button" class="btn-secondary" (click)="closeUpdatePopup()">‚ùå ◊°◊í◊ï◊®</button>
        </div>
      </form>
    </div>
  </div>
}